---
marp: true
paginate: true
---

<style>
img[alt~="center"] {
  display: block;
  margin: 0 auto;
}
.columns {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.5rem;
}
</style>

# –§–∞–π–ª—ã

---

# –ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∞–π–ª?

---

# –ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∞–π–ª?
–§–∞–π–ª ‚Äì —ç—Ç–æ —Å—É—â–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ, –∏–º–µ–µ—Ç –∏–º—è –∏ –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

---

# –ò–º—è —Ñ–∞–π–ª–∞
* –ù–µ –±–æ–ª–µ–µ `PATH_MAX` (–≤–∫–ª—é—á–∞—è `\0`) —Å–∏–º–≤–æ–ª–æ–≤: 4 –ö–± –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –û–°, 256 –±–∞–π—Ç –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏
* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø—É—Ç–∏ ‚Äì `/`, —á–∞—Å—Ç–∏ –ø—É—Ç–∏ –Ω–µ –±–æ–ª–µ–µ 255 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∂–¥–∞—è
* –°–∞–º–æ—ë –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ ‚Äì `/` ‚Äì —Å–∞–º–∞—è –≤–µ—Ä—Ö–Ω–µ—É—Ä–æ–≤–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–∫–æ—Ä–Ω–µ–≤–∞—è)
* –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å: –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∫–æ—Ä–Ω—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `/Users/carzil/mipt`)
* –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `carzil/mipt`)
* `.` ‚Äì —Ç–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (`./carzil/mipt` = `carzil/mipt` –∏ `./carzil/./././mipt` = `./carzil/mipt`)
* `..` ‚Äì –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤—ã—à–µ (`/Users/carzil/mipt/..` = `/Users/carzil`)

---

# Everything is a file
* –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã
* –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
* –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏
* FIFO (–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã)
* –°–æ–∫–µ—Ç—ã

---

# –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
* On-disk —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
* –†–∞–±–æ—Ç–∞—é—Ç –ø–æ–≤–µ—Ä—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (HDD, SSD, NVMe)
* –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ *–±–ª–æ–∫–∏*, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–∏–±–æ –¥–∞–Ω–Ω—ã–µ, –ª–∏–±–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
* –†–∞–∑–º–µ—Ä –±–ª–æ–∫–æ–≤ –æ–±—ã—á–Ω–æ 512 –±–∞–π—Ç –∏–ª–∏ 4 –ö–±
* –§–∞–π–ª—ã –∑–∞–Ω–∏–º–∞—é—Ç –±–ª–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏

---

# –ö–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –≤ –æ–¥–Ω–æ–π –û–°?
* Windows-way: `C:`, `D:`, `A:`, etc
* UNIX-way: –µ–¥–∏–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º—ë–Ω
* –í—Å–µ —Ñ–∞–π–ª—ã, –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º ‚Äì —ç—Ç–æ –≤—Å—ë-–≤—Å—ë-–≤—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ **–µ–¥–∏–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ**
* VFS = Virtual file system

---

# –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞

```c
#include <unistd.h>

int open(const char *pathname, int flags, mode_t mode);
ssize_t read(int fd, void *buf, size_t count);
ssize_t write(int fd, const void *buf, size_t count);
int close(int fd);
```

---

# –ü–æ–∑–∏—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞
<div class="columns">
<div>

* –° –∫–∞–∂–¥—ã–º _—Ñ–∞–π–ª–æ–≤—ã–º –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–º_ —Å–≤—è–∑–∞–Ω–∞ —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ —Ñ–∞–π–ª–µ
* read/write –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é
* `lseek` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–º–µ—â–∞—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
* `off_t = int32_t` –Ω–∞ 32-–±–∏—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö!

</div>
<div>

```c

#define SEEK_SET ...
#define SEEK_CUR ...
#define SEEK_END ...

off_t lseek(int fd, off_t offset, int whence);
off64_t lseek64(int fd, off64_t offset, int whence);
```

</div>
</div>

---

# –†–∞–±–æ—Ç–∞ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞
<div class="columns">
<div>

* –ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é —Å–µ–º–µ–π—Å—Ç–∞ —Å–∏—Å–∫–æ–ª–ª–æ–≤ `*stat`
* –í—Å–µ –æ–Ω–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `struct stat`
* `lstat` –Ω–µ —Å–ª–µ–¥—É–µ—Ç –ø–æ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–º —Å—Å—ã–ª–∫–∞–º

</div>
<div>

```c
#include <sys/stat.h>

int stat(const char* path, struct stat* buf);
int fstat(int fd, struct stat *stat);
int lstat(const char* path, struct stat* stat);

struct stat {
    dev_t     st_dev;
    ino_t     st_ino;
    mode_t    st_mode;
    nlink_t   st_nlink;
    uid_t     st_uid;
    gid_t     st_gid;
    dev_t     st_rdev;
    off_t     st_size;
    blksize_t st_blksize;
    blkcnt_t  st_blocks;
    struct timespec st_atime/st_mtime/st_ctime;
};
```

</div>
</div>

---

# –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
<div class="columns">
<div>

* rwx = **R**ead/**W**rite/e**X**ecute
* 9 –±–∏—Ç, 3 –≥—Ä—É–ø–ø—ã
* –ü—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞, –ø—Ä–∞–≤–∞ –≥—Ä—É–ø–ø—ã –∏ –ø—Ä–∞–≤–∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
* –ß–∞—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —á–∏—Å–ª–∞ –≤ –≤–æ—Å—å–º–∏—Ä–∏—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å—á–∏—Å–ª–µ–Ω–∏—è
* $777_8 = 111111111_2$ = `rwxrwxrwx`
* $644_8 = 110100100_2$ = `rw-r--r--`
* `st_uid`/`st_gid` —Å–æ–¥–µ—Ä–∂–∏—Ç ID –≤–ª–∞–¥–µ–ª—å—Ü–∞/–≥—Ä—É–ø–ø—ã-–≤–ª–∞–¥–µ–ª—å—Ü–∞

</div>
<div>

```c
struct stat {
    // ...
    mode_t    st_mode;
    uid_t     st_uid;
    gid_t     st_gid;
    // ...
};
```

</div>

---

# –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
* r ‚Äì –ª–∏—Å—Ç–∏–Ω–≥ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
* w ‚Äì —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤–Ω—É—Ç—Ä–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
* x ‚Äì –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (cd), –∞ —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º

---

# –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã
<div class="columns">
<div>

* `S_ISREG(stat.st_mode)`
* –û–±—ã—á–Ω—ã–µ —Ñ–∞–π–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏
* –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–ª–æ–∫–∞—Ö –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
* `st_size` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–π—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞
* `st_blocks` ‚Äì –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ —Ñ–∞–π–ª–∞ (–ø–æ–¥ –±–ª–æ–∫–æ–º –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç—Å—è 512 –±–∞–π—Ç–æ–≤—ã–π –±–ª–æ–∫)
* `st_blksize` ‚Äì –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
* `st_atime/st_mtime` ‚Äì –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø/–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è

</div>
<div>

```c
struct stat {
    // ...
    mode_t    st_mode;
    off_t     st_size;
    blksize_t st_blksize;
    blkcnt_t  st_blocks;
    struct timespec st_atime/st_mtime;
    // ...
};
```

</div>

---

# –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã
–ß—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–µ—Ä–Ω–æ?
* `st_size < st_blocks * 512`
* `st_size == st_blocks * 512`
* `st_size > st_blocks * 512`

---

# –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã
* `st_size < st_blocks * 512`: —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –∫—Ä–∞—Ç–µ–Ω —Ä–∞–∑–º–µ—Ä—É –±–ª–æ–∫–∞
* `st_size == st_blocks * 512`: —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∫—Ä–∞—Ç–µ–Ω —Ä–∞–∑–º–µ—Ä—É –±–ª–æ–∫–∞
* `st_size > st_blocks * 512`: –≤ —Ñ–∞–π–ª–µ –µ—Å—Ç—å ¬´–¥—ã—Ä–∫–∏¬ª ‚Äì –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –Ω—É–ª—è–º–∏

---

# –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å ¬´–¥—ã—Ä–∫–∏¬ª –≤ —Ñ–∞–π–ª–∞—Ö?
<div class="columns">
<div>

* `lseek` + `write`
* `truncate` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –±–∞–π—Ç—ã —Å –∫–æ–Ω—Ü–∞
* `fallocate` —É–º–µ–µ—Ç: –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω—É–ª–µ–≤—ã—Ö –±–∞–π—Ç –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –º–µ—Å—Ç–æ, –≤—ã—Ä–µ–∑–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω, –æ–±–Ω—É–ª—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
* –ú–µ–Ω—è—é—Ç —Å—Ç—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–∫–µ, –Ω–æ –Ω–µ —Å–∞–º–∏ –¥–∞–Ω–Ω—ã–µ!
* `This is a nonportable, Linux-specific system call.` üôÅ

</div>
<div>

```c
int fallocate(int fd, int mode, off_t offset, off_t len);
int truncate(const char *path, off_t length);
int ftruncate(int fd, off_t length);
```

![center height:300px](./fallocate_vs_truncate.png)

</div>
</div>

---

# inode
* –£ —Ñ–∞–π–ª–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ –∏–º—ë–Ω, –Ω–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —ç—Ç–æ–º –æ–Ω –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ–π –∫–æ–ø–∏–∏
* inode ‚Äì —ç—Ç–æ _—Å–∞–º–∞ —Å—É—â–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞_, –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–∞ ‚Äì ¬´—É–∫–∞–∑–∞—Ç–µ–ª–∏¬ª –Ω–∞ –Ω–µ—ë
* –£ –∫–∞–∂–¥–æ–π inode –µ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π ID
* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ inode –æ–≥—Ä–∞–Ω–∏—á–Ω–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

---

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
<div class="columns">
<div>

* `S_ISDIR(stat.st_mode)`
* –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Å–ø–∏—Å–æ–∫ _directory entry_ –∏–ª–∏ _dirent_
* –ö–∞–∂–¥–∞—è dirent —Ö—Ä–∞–Ω–∏—Ç –∏–º—è —Ñ–∞–π–ª–∞ –∏ inode, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –æ–Ω–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç
* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π API –¥–ª—è —á—Ç–µ–Ω–∏—è: –æ–±—ã—á–Ω—ã–µ `read`/`write` –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
* –†–∞–∑–º–µ—Ä `struct dirent` –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω!

</div>
<div>

```c
struct dirent {
    ino_t          d_ino;
    unsigned short d_reclen;
    unsigned char  d_type;
    char           d_name[];
    // ...
};


DIR* opendir(const char* name);
struct dirent* readdir(DIR* dirp);
void rewinddir(DIR *dirp);
int closedir(DIR *dirp);

int mkdir(const char *pathname, mode_t mode);
int rmdir(const char *pathname);
```

</div>

---

```
$ ls -lah public-basic-2023
total 24
24290740 drwxr-xr-x   9 carzil  staff   288 Sep 11 18:08 .
 3349887 drwxr-xr-x  18 carzil  staff   576 Sep 11 18:12 ..
24290745 drwxr-xr-x  15 carzil  staff   480 Sep 11 18:09 .git
24301574 -rw-r--r--   1 carzil  staff   765 Sep 11 18:08 .gitlab-ci.yml
24301575 drwxr-xr-x   3 carzil  staff    96 Sep 11 18:08 00-intro
24301588 drwxr-xr-x   4 carzil  staff   128 Sep 11 18:08 01-data-representation
24301615 -rw-r--r--   1 carzil  staff  2704 Sep 11 18:08 GUIDE.md
24301616 -rw-r--r--   1 carzil  staff   320 Sep 11 18:08 README.md
24301617 -rw-r--r--   1 carzil  staff     0 Sep 11 18:08 requirements.txt
```

---

# –ñ—ë—Å—Ç–∫–∏–µ —Å—Å—ã–ª–∫–∏

<div class="columns">
<div>

* –ê–Ω–∞–ª–æ–≥ `std::shared_ptr` –¥–ª—è inode
* –°—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
* –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂—ë—Å—Ç–∫–∏—Ö —Å—Å—ã–ª–æ–∫ —Å—Ç–∞–ª–æ —Ä–∞–≤–Ω–æ 0, —Ç–æ inode —É–¥–∞–ª—è–µ—Ç—Å—è
* `stat.st_nlink` —Ö—Ä–∞–Ω–∏—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂—ë—Å—Ç–∫–∏—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ñ–∞–π–ª
* –ù–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª, –∞ _—Å—É—â–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã_
* –£–¥–∞–ª–µ–Ω–∏–µ ‚Äì `unlink`, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ ‚Äì `rename`

</div>
<div>

```c
struct stat {
    // ...
    nlink_t   st_nlink;
    // ...
};

int link(const char *old, const char *new);
int unlink(const char *name);
int rename(const char *old, const char *new);
```

</div>
</div>

---

# –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏

* `S_ISLNK(stat.st_mode)`
* –û—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞
* –ê–Ω–∞–ª–æ–≥ `std::weak_ptr` –¥–ª—è inode
* Dangling symlinks: —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç

```c
ssize_t readlink(const char* path, char* buf, size_t sz);
int symlink(const char* target, const char* linkpath);
```

---

![center width:1200px](./vfs.svg)

---

# **Everything** is a file!
* –î–∞–∂–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, –∑–≤—É–∫–æ–≤—ã–µ –∫–∞—Ä—Ç—ã, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã, —Ñ–ª–µ—à–∫–∏, —Å–µ—Ç–µ–≤—ã–µ –∫–∞—Ä—Ç—ã, –¥–∏—Å–∫–∏, –≤–∏–¥–µ–æ –∫–∞—Ä—Ç—ã etc
* –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π _–ø—Å–µ–≤–¥–æ-—Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ_
* –§–∞–π–ª—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –û–°
* –°–∏–º–≤–æ–ª—å–Ω—ã–µ –∏ –±–ª–æ—á–Ω—ã–µ

---

# –°–∏–º–≤–æ–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (character device)
* `S_ISCHR(stat.st_mode)`
* –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞—Ç—å
* –ó–≤—É–∫–æ–≤–∞—è –∫–∞—Ä—Ç–∞, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã (COM), —Å–µ—Ç–µ–≤—ã–µ –∫–∞—Ä—Ç—ã, etc

# –ë–ª–æ—á–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (block device)
* `S_ISBLK(stat.st_mode)`
* –†–∞–∑–±–∏—Ç—ã –Ω–∞ –±–ª–æ–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
* –ú–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ª—é–±–æ–π –±–ª–æ–∫
* HDD, SSD, NAS, Floppy, etc

---

# –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
* –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã ‚Äì –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –µ–¥–∏–Ω—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É (VFS)
* `mount` ‚Äì —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
* `source` ‚Äì —ç—Ç–æ (–æ–±—ã—á–Ω–æ) –±–ª–æ—á–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–∏—Å–∫–∞ (–∏–ª–∏ —Ä–∞–∑–¥–µ–ª–∞)
* `target` ‚Äì —ç—Ç–æ –∫—É–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–æ–Ω–∏—Ç–∏—Ä–æ–≤–∞—Ç—å


```c
int mount(
    const char* source, const char* target,
    const char* filesystemtype, unsigned long mountflags,
    const void* data
);
int umount(const char *target);
```

---

# ext2
* Linux, 1993 –≥–æ–¥
* –î–∏—Å–∫ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –±–ª–æ–∫–∏ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (—ç—Ç–æ—Ç —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ, —á–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
* –ë–ª–æ–∫–∏ –æ–∫–æ–ª–æ –Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞—é—Ç _—Ç–∞–±–ª–∏—Ü—É inode_ –∏ –±–∏—Ç–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –∑–∞–Ω—è—Ç—ã—Ö –±–ª–æ–∫–æ–≤ –Ω–∞ –¥–∏—Å–∫
* –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ —Ö—Ä–∞–Ω—è—Ç –¥–∞–Ω–Ω—ã–µ
* inode #2 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
* –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –≤–∏–¥–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ dirent

![center width:800px](./ext2_block_group.svg)

---

![center width:1200px](./ext2_inode.svg)

---

# –ü—Ä–æ–±–ª–µ–º—ã ext2
* –ò–∑–º–µ–Ω–µ–Ω–∏–µ inode —Ç—Ä–µ–±—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π –Ω–∞ –¥–∏—Å–∫, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å—Å—è
* –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–∞ –≤ –±–æ–ª—å—à–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö –∑–∞–Ω–∏–º–∞–µ—Ç –ª–∏–Ω–µ–π–Ω–æ–µ –≤—Ä–µ–º—è
* –î–∞–∂–µ –µ—Å–ª–∏ –±–ª–æ–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ –¥–∏—Å–∫–µ, –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –ø–æ–¥ –Ω–µ–≥–æ –∑–∞–ø–∏—Å—å

---

# ext4
* 2006 –≥–æ–¥
* –î–µ-—Ñ–∞–∫—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è Linux
* _–ñ—É—Ä–Ω–∞–ª–∏—Ä—É–µ–º–∞—è_
* –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTree
* extents ‚Äì ¬´—Ä–µ–≥–∏–æ–Ω—ã –¥–∏—Å–∫–∞¬ª
* –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –±–ª–æ–∫–æ–≤

---

# sysfs –∏ procfs
* ¬´–ú–µ—Ç–∞—Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã¬ª
* –ù–µ –∏–º–µ—é—Ç –Ω–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–∫–µ, –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —è–¥—Ä–∞ Linux
* –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–∏—Å–∫–æ–ª–ª—ã

---

# procfs
* `/proc/<pid>/status` ‚Äì —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
* `/proc/<pid>/fd/N` ‚Äì –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª—ã –∑–∞ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ —Ñ–∞–π–ª–æ–≤—ã–º–∏ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞–º–∏
* `/proc/<pid>/exe` ‚Äì —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
* `/proc/<pid>/cwd` ‚Äì —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ—Ü–µ—Å—Å–∞
* `/proc/<pid>/environ` ‚Äì —Å–ø–∏—Å–æ–∫ environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞
* `/proc/<pid>/cmdline` ‚Äì —Å–ø–∏—Å–æ–∫ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞

---

```
$ cat /proc/self/status
Name:	cat
Umask:	0022
State:	R (running)
Pid:	1466
Uid:	0	0	0	0
Gid:	0	0	0	0
FDSize:	256
Groups:	0
VmPeak:	    2344 kB
VmSize:	    2344 kB
VmLck:	       0 kB
VmPin:	       0 kB
VmHWM:	     784 kB
VmRSS:	     784 kB
RssAnon:	      76 kB
RssFile:	     708 kB
RssShmem:	       0 kB
SigPnd:	0000000000000000
SigBlk:	0000000000000000
SigIgn:	0000000000000000
CapInh:	0000000000000000
CapPrm:	00000000a80425fb
CapEff:	00000000a80425fb
CapBnd:	00000000a80425fb
CapAmb:	0000000000000000
Cpus_allowed:	ff
Cpus_allowed_list:	0-7
Mems_allowed:	1
Mems_allowed_list:	0
...
```

---

# FUSE
* –ö–æ–¥ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –æ–±—ã—á–Ω–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –≤ —è–¥—Ä–µ ‚Äì —ç—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ
* FUSE = file system in userspace
* –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å
* –ö–∞–∫? –ß–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∫–æ–Ω–µ—á–Ω–æ! `/dev/fuse`

---

# „ÅÇ„Çä„Åå„Å®„ÅÜ!
